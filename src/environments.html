<!DOCTYPE html>
<html>
  <head>
    <title>mlproj - Environments</title>

    <!-- CSS stylesheets -->
    <link href="css/bootstrap.css"  rel="stylesheet" type="text/css" />
    <link href="css/clean-blog.css" rel="stylesheet" type="text/css" />

    <!-- fonts -->
    <link href="css/font-awesome.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
  </head>
  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top" id="navbar">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            Menu <i class="fa fa-bars"></i>
          </button>
          <a class="navbar-left" href="./" style="margin-top: 15px;">
            <img src="images/package-icon.png" style="height: 33px;" />
          </a>
        </div>
        <!-- the menu items -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="./">Introduction</a></li>
            <li><a href="start">Get started</a></li>
            <li><a href="commands">Commands</a></li>
            <li><a href="projects">Projects</a></li>
            <li><a href="environments">Environments</a></li>
            <li><a href="config">Config</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <article>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

            <h1>Environments</h1>
            <p>
              This page documents the environment file format.  It contains the following
              sections:
            </p>
            <ul>
              <li><a href="#intro">Introduction</a></li>
              <li><a href="#overall">Overall structure</a></li>
              <li><a href="#params">Parameters</a></li>
              <li><a href="#import">Imports</a></li>
              <li><a href="#databases">Databases</a></li>
              <li><a href="#servers">Servers</a></li>
            </ul>
            <p>
              You can find examples of environment files in
              <a href="http://github.com/fgeorges/mlproj/tree/master/test/environs">
                <code>test/environs/</code></a> (individual sets of environment files) and
              <a href="http://github.com/fgeorges/mlproj/tree/master/test/projects">
                <code>test/projects/</code></a> (more complete projects, including
              environment files.)
            </p>
            <blockquote>
              This is not covering all aspects and all possible properties of databases,
              forests and servers.  It is still work in progress.  The goal is to support
              all properties supported by the Management API of MarkLogic.  If you need
              one that is not supported yet, make sure to open an issue about it, so it
	      moves to the top of the list.  Look at the <a href="properties">property</a>
              list, with a detailed support status.
            </blockquote>
            <p></p>

            <a class="anchor" id="intro"></a>
            <h3>Introduction</h3>
            <p>
              The environment files describe the details of a MarkLogic environment.  They
              includes connection details, but also all the components and their details.
              "Component" is a generic term used here to refer to both databases and app
              servers.
            </p>
            <p>
              The environment files are stored in a project in the
              directory <code>xproject/mlenvs/</code>.  The name of the file is the name
              of the environment (with the extension <code>.json</code>.)  For instance,
              the environment "prod" is in <code>xproject/mlenvs/prod.json</code>.
            </p>
            <p>
              Most commands need an environment to operate upon (e.g. <code>deploy</code>)
              whilst other do not (e.g. <code>new</code>.)  There are 3 ways of specifying
              the environment for a command to use:
            </p>
            <ul>
              <li>using the default environment
                in <code>xproject/mlenvs/default.json</code>; typically this one only
                imports another one, and is not checked in your source revision control,
                so everyone can set a different default environment</li>
              <li>pass an environment by name, using the option <code>-e</code>; its value
                is used to construct a file
                name: <code>xproject/mlenvs/{name}.json</code></li>
              <li>pass the path to an environment file, using the
                option <code>-f</code></li>
            </ul>
            <p></p>

            <a class="anchor" id="overall"></a>
            <h3>Overall structure</h3>
            <p>
              The overall structure of an environment file is like the following:
            </p>
            <pre>
{
    "mlproj": {
        "format": "0.1",
        "import": "base.json",
        "code":   "awesome-app",
        "title":  "Short title for the environment",
        "desc":   "Longer description of the environment.  You can use **Markdown**.",
        "srcdir": "...",
        "connect": {
            "host":     "...",
            "user":     "...",
            "password": "..."
        },
        "params": {
            "..."
        },
        "databases": [{
            "..."
        }],
        "servers": [{
            "..."
        }]
    }
}</pre>
            <p>
              All properties are optional, except for <code>format</code>, which is the
              version of the file format (for now always 0.1, until it stabilizes).  The
              simple properties are:
            </p>
            <ul>
              <li><code>code</code> - The code is a short code, containing only ASCII
                alphanumeric characters (as well as <code>-</code> and _). It is typically
                used to refer to the project, and to build component names in a consistent
                way (for databases, forests and servers).</li>
              <li><code>title</code> - The title is a short, human-friendly description of
                the environment. It can use Markdown notation (the notation used in
                Github).</li>
              <li><code>desc</code> - The description is a longer description of the
                environment than the title. It can use Markdown notation.</li>
              <li><code>srcdir</code> - The source directory is the path to the directory
                  with the sources of the project. This property is generally set
                  automatically, when used in a standard <code>XProject</code> structure,
                  as the directory <code>src/</code>.  <br /> It is sometimes useful to
                  set it explicitly for either 1) represent a more complex setup, or 2)
                  still be able to use those files with a project with another structure
                  than the standard <code>XProject</code> structure.</li>
              <li><code>connect</code> - This property contains connection information:
                the user name to use, its password, as well as the host where MarkLogic is
                installed.</li>
            </ul>
            <p>
              These properties can also be referred to in other places, for "variable
              substitutions" (see the section on <a href="#params">parameters</a> for
              details on substitution.)
            </p>
            <p>
              The <code>code</code>, <code>srcdir</code>, and the
              three <code>connect</code> properties (host, user, password) can be set with
              options on the command line.  The value set on the command line takes
              precedence over the corresponding value in the environment file, if any,
              which is convenient to use another value without modifying any file.  See
              the <a href="commands">global options</a> for details.
            </p>

            <a class="anchor" id="params"></a>
            <h3>Parameters</h3>
            <p>
              The property <code>params</code> is a plain JSON object for you to create
              variables.  Parameters are key/value pairs: they have a name (the object
              property key) and a value (the corresponding object value).  Values must be
              strings.
            </p>
            <p>
              Parameters can be referred to in other places of the files, by using the
              <code>${...}</code> notation.  Anywhere in a string value, this notation is
              replaced by the actual value of the parameter of that name.  This is called
              "variable substitution".  Parameters can be "overriden" (assigned a
              different value) in an importing file, or on the command line.
            </p>
            <p>
              The notation <code>@{...}</code> (with an "at" sign instead of a "dollar"
              sign) do not use parameters, but values comming from "standard" properties.
              You can use the following variable substitutions, referring to properties
              with the same name:
            </p>
            <ul>
              <li><code>@{code}</code></li>
              <li><code>@{title}</code></li>
              <li><code>@{desc}</code></li>
              <li><code>@{srcdir}</code></li>
              <li><code>@{host}</code></li>
              <li><code>@{user}</code></li>
              <li><code>@{password}</code></li>
            </ul>
            <p>
              A typical use of <code>@{code}</code> is to construct component names, and
              for parameters it is to capture variable parts like port numbers:
            </p>
            <pre>
{
    "name": "@{code}-server",
    "type": "http",
    "port": "${port}"
}</pre>
            <p></p>

            <a class="anchor" id="import"></a>
            <h3>Imports</h3>
            <p>
              The value of the property <code>import</code> is a path to another file to
              import, relative to the current file.  Usually it is simply a file name, as
              they are all grouped in the same directory.  Starting at one file, its
              <code>import</code> is resolved if any, then recursively all their imports
              are resolved, to get a larger environment object.
            </p>
            <p>
              At each step, if the imported file contains a parameter already existing in
              an importing file, it is "overriden" (hidden).
            </p>
            <p>
              At each step, if the imported file contains a component (database or server)
              already existing in an importing file (same ID or same name), it is
              "merged".  The properties of that component in the importing file hide the
              properties with the same name in the imported file.
            </p>
            <p>
              If you want a component to entirely override one with the same name in an
              imported file, use the property <code>compose</code> with the value
              <code>hide</code>.  By default it is <code>merge</code>.
            </p>
            <p>
              Let say we point to the following environment file:
            </p>
            <pre>
{
    "mlproj": {
        "format": "0.1",
        "import": "base.json",
        "title":  "The local environment for development",
        "connect": {
            "host":     "localhost",
            "user":     "admin",
            "password": "admin"
        },
        "params": {
            "port": 8099
        },
        "servers": [{
            "id": "server",
            "modules": {
                "name": "@{code}-modules"
            }
        }]
    }
}</pre>
            <p>
              and the following in <code>base.json</code>:
            </p>
            <pre>
{
    "mlproj": {
        "format": "0.1",
        "code":   "my-app",
        "title":  "The base environment config",
        "params": {
            "port": 8080,
            "root": "/"
        },
        "databases": [{
            "id":   "content",
            "name": "@{code}-content"
        }],
        "servers": [{
            "id":   "server",
            "name": "@{code}",
            "type": "http",
            "port": "${port}",
            "root": "${root}",
            "content": {
                "idref": "content"
            }
        }]
    }
}</pre>
            <p>
              Then the first one is somewhat equivalent to the following file, where
              imports and variable substitutions have been resolved:
            </p>
            <pre>
{
    "mlproj": {
        "format": "0.1",
        "code":   "my-app",
        "title":  "The local environment for development",
        "connect": {
            "host":     "localhost",
            "user":     "admin",
            "password": "admin"
        },
        "servers": [{
            "name": "my-app",
            "type": "http",
            "port": "8099",
            "root": "/",
            "content": {
                "name": "my-app-content"
            },
            "modules": {
                "name": "my-app-modules"
            }
        }]
    }
}</pre>
            <p>
              Note like the properties for the server have been merged from both
              files. Note as well that <code>${port}</code> is resolved to the parameter
              with that name with the highest import precedence (in the importing file),
              even though it is used in another file (in the imported file).
            </p>
            <p>
              If you need to import several files, you can use an array of strings instead
              of a single string as the value of <code>import</code>
            </p>
            <pre>"import": [ "one.json", "two.json", "three.json" ]</pre>
            <p></p>

            <a class="anchor" id="databases"></a>
            <h3>Databases</h3>
            <p>
              The property <code>databases</code> is an array of databases.  Each database
              has a name, and might have an ID.  It contains all the properties you want
              to set when creating the database.
            </p>
            <h4>Database details</h4>
            <p>
              As the database object definition is the most complex one, it is maintained
              on its own <a href="databases">documentation page</a>.
            </p>
            <h4>Database references</h4>
            <p>
              In addition to the global array of databases, there are a few places in an
              environment file expecting a database object (namely, to set the content or
              modules database of a server, or to set the schema, security or triggers
              database of another database).
            </p>
            <p>
              In those place, you can either put a full database object definition, or
              rather use a <em>database reference</em>.  A database reference is an object
              containing only one property: <code>idref</code> to point to a database by
              ID, or <code>nameref</code> to point to a database by name:
            </p>
            <pre>
"schema": {
    "nameref": "@{code}-schema"
},
"security": {
    "idref": "security"
},</pre>
            <p></p>

            <a class="anchor" id="servers"></a>
            <h3>Servers</h3>
            <p>
              The property <code>servers</code> is an array of servers.  Each server is an
              object that looks like the following:
            </p>
            <pre>
{
    "id":   "app",
    "name": "@{code}",
    "type": "http",
    "port": "${port}",
    "root": "/",
    "rewriter": "/plumbing/rewriter.sjs",
    "handler":  "/plumbing/errors.sjs",
    "content": {
        <em>(database object or ref)</em>
    },
    "modules": {
        <em>(database object or ref)</em>
    },
    "output": {
        <em>(serialization options)</em>
    }
}</pre>
            <p>
              The various properties are:
            </p>
            <ul>
              <li><code>id</code> - a unique ID used only in the environment files, to
                refer to servers</li>
              <li><code>name</code> - the name of the server, as it will be set on
                MarkLogic</li>
              <li><code>type</code> - the server type (either <code>http</code>,
                <code>webdav</code>, <code>xdbc</code> or <code>odbc</code>)</li>
              <li><code>port</code> - the port number to use for the server</li>
              <li><code>root</code> - the root for modules (either on the file system, or
                on the modules database if it is set)</li>
              <li><code>rewriter</code> - the path to the URL rewriter</li>
              <li><code>handler</code> - the path to the error handler</li>
              <li><code>content</code> and <code>modules</code> - resp. the content
                database and the modules database.  They can be either a full-fledged
                database object, or a reference to an existing database description
                (using <code>idref</code> or <code>nameref</code>)</li>
            </ul>
            <h4>Output</h4>
            <p>
              The property <code>output</code> is an object that contains serialization
              options for the server:
            </p>
            <pre>
"output": {
    "byte-order-mark"             : "no",
    "cdata-section-localname"     : "...",
    "cdata-section-namespace-uri" : "...",
    "doctype-public"              : "...",
    "doctype-system"              : "...",
    "encoding"                    : "UTF-8",
    "escape-uri-attributes"       : "yes",
    "include-content-type"        : "yes",
    "include-default-attributes"  : "no",
    "indent"                      : "yes",
    "indent-tabs"                 : "no",
    "indent-untyped"              : "yes",
    "media-type"                  : "...",
    "method"                      : "xhtml",
    "normalization-form"          : "none",
    "omit-xml-declaration"        : "default",
    "sgml-character-entities"     : "none",
    "standalone"                  : "omit",
    "undeclare-prefixes"          : "default",
    "version"                     : "2.0"
}</pre>
            <p>
              Each property corresponds to the property <code>output-{name}</code> in the
              Management API.  For instance, <code>doctype-public</code> corresponds to
              <code>putput-doctype-public</code>.
            </p>

          </div>
        </div>
      </div>
    </article>

    <!-- JS libraries -->
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/clean-blog.js"></script>

  </body>
</html>
